<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProjectOverview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .chart-container {
      position: relative;
      margin: 0 auto;
      width: 100%;
      max-width: 400px;
      height: 300px;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Navigation -->
  <nav class="bg-white shadow sticky top-0 z-50" role="navigation" aria-label="Main Navigation">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="text-2xl font-bold text-blue-600" aria-label="Maṉa Home">Maṉa</a>
      <div class="hidden md:flex space-x-6">
        <a href="/" class="text-gray-600 hover:text-gray-900" aria-label="Home">Home</a>
        <a href="/Research#portfolio" class="text-gray-600 hover:text-gray-900" aria-label="Portfolio">Portfolio</a>
        <a href="/Research#collaborators" class="text-gray-600 hover:text-gray-900" aria-label="Collaborators">Collaborators</a>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <section class="container mx-auto px-4 py-12">
    <h1 class="text-4xl font-bold text-blue-600 text-center mb-8">Welcome to Maṉa</h1>
    <p class="text-lg text-gray-700 max-w-3xl mx-auto text-center mb-12">
      Maṉa is a web-based application for mental health analysis via social media.
      Our system uses advanced NLP models to analyze your social media comments and offers personalized guidance.
    </p>

    <!-- Platform Descriptions Box -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12" aria-label="Platform Descriptions">
      <!-- ManaChat Box -->
      <div class="bg-white p-6 rounded-lg shadow flex flex-col items-center">
        <div class="mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M2 3h20v2H2V3zm0 4h20v2H2V7zm0 4h14v2H2v-2zm0 4h20v2H2v-2z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-semibold mb-2">MaṉaChat</h2>
        <p class="text-gray-700 mb-4 text-center">
          Get instant, empathetic responses from our chatbot designed to provide quick mental health support and stress reduction tips.
        </p>
        <a href="/Manachat" class="px-4 py-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition" aria-label="Start ManaChat">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M2 3h20v2H2V3zm0 4h20v2H2V7z"/>
          </svg>
          Start Chat
        </a>
      </div>
      <!-- ManaNow Box -->
      <div class="bg-white p-6 rounded-lg shadow flex flex-col items-center">
        <div class="mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2L1 21h22L12 2zm0 3.84L19.53 19H4.47L12 5.84z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-semibold mb-2">MaṉaNow</h2>
        <p class="text-gray-700 mb-4 text-center">
          Dive deeper into your mental health with our detailed assessment. If our analysis shows predominantly negative sentiment,
          we recommend a full evaluation to help you access professional support.
        </p>
        <a href="/ManaNow" class="px-4 py-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition" aria-label="Start ManaNow">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 2L1 21h22L12 2zm0 3.84L19.53 19H4.47L12 5.84z"/>
          </svg>
          Start Assessment
        </a>
      </div>
    </div>

    <!-- Assessment Trigger Explanation Box (conditionally shown) -->
    <div id="assessmentExplanation" class="bg-white p-6 rounded-lg shadow mb-12 hidden" aria-label="Assessment Explanation">
      <h2 class="text-xl font-semibold mb-2">Why Proceed to a Full Assessment?</h2>
        <p class="text-gray-700 mb-4">
          Our analysis shows that the overall negative sentiment in your comments is higher than the positive.
          This may indicate that you are experiencing significant stress or emotional difficulties.
          A detailed mental health assessment can provide deeper insights and guide you toward the appropriate support and resources.
        </p>
        <button onclick="window.location.href='/ManaNow'" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700" aria-label="Proceed to Mental Health Assessment">
            Proceed to Mental Health Assessment
        </button>
    </div>

    <!-- Upload & Analysis Box (Two-Column Layout) -->
    <div class="bg-white p-6 rounded-lg shadow mb-12" aria-label="Upload and Analysis">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Left Column: Upload Controls and Explanation -->
        <div class="md:w-1/2">
          <h2 class="text-xl font-semibold mb-2">Upload Your Comments (JSON)</h2>
          <p class="text-gray-600 mb-4">
            Export your social media comments (Instagram, Twitter, etc.) in JSON format and upload your file below.
            <strong>Only the "value" field under "Comment" is used for analysis.</strong>
          </p>
          <label for="fileUpload" class="sr-only">Upload JSON file</label>
          <input type="file" id="fileUpload" accept=".json" class="mb-4 block" aria-label="Upload JSON file">
          <button onclick="uploadComments()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" aria-label="Upload and Analyze">
            Upload and Analyze
          </button>
          <div id="uploadResult" class="mt-4 text-gray-700" aria-live="polite"></div>
        </div>
        <div class="mt-4 flex gap-2">
          <button onclick="saveAnalysis()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700" aria-label="Save Analysis">
            Save Analysis
          </button>
          <button onclick="refreshPage()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700" aria-label="Refresh Page">
            Refresh
          </button>
          <!--<button id="downloadReportBtn" onclick="downloadReport()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 hidden" aria-label="Download Report">
            Download Report
          </button>-->
        </div>
        <!-- Right Column: Chart Visualization -->
        <div class="md:w-1/2 flex items-center justify-center">
          <div id="chartContainer" class="chart-container hidden" aria-label="Sentiment Analysis Chart">
            <canvas id="sentimentChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Add a section for downloading reports -->
    <section id="downloadReportsSection" class="hidden bg-white p-6 rounded-lg shadow mb-12">
      <h2 class="text-xl font-semibold mb-4">Download Reports</h2>
      <div id="reportList" class="space-y-4">
        <!-- Reports will be dynamically added here -->
      </div>
    </section>

    <!-- Detailed Sentiment Table Section (conditionally shown) -->
    <div id="sentimentTableSection" class="bg-white p-6 rounded-lg shadow hidden" aria-label="Detailed Sentiment Analysis">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Detailed Sentiment Analysis</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
          <thead>
            <tr class="bg-gray-100">
              <th class="py-2 px-4 text-left text-gray-600 font-medium">Extracted Text</th>
              <th class="py-2 px-4 text-left text-gray-600 font-medium">Sentiment</th>
            </tr>
          </thead>
          <tbody id="sentimentTableBody">
            <!-- Table rows inserted dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-200 py-4 mt-8" role="contentinfo" aria-label="Site Footer">
    <div class="container mx-auto px-4 text-center text-gray-600">
      &copy; 2025 Maṉa. All rights reserved.
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    let sentimentChart = null;

    async function uploadComments() {
      const fileInput = document.getElementById('fileUpload');
      const uploadResult = document.getElementById('uploadResult');
      const assessmentExplanation = document.getElementById('assessmentExplanation');

      if (!fileInput.files.length) {
        alert("Please select a file to upload.");
        return;
      }
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch('/api/upload-comments', {
          method: 'POST',
          body: formData
        });
        if (!response.ok) {
          console.error("Response not ok:", response.statusText);
          throw new Error("Network response was not ok");
        }
        const result = await response.json();
        if (result.error) {
          uploadResult.textContent = "Error processing file: " + result.error;
          return;
        }
        uploadResult.textContent =
          `Sentiment Analysis - Positive: ${result.positive}, Neutral: ${result.neutral}, Negative: ${result.negative}`;
        
        // Display the doughnut chart
        showDoughnutChart(result.positive, result.neutral, result.negative);
        
        // If negative exceeds positive, show the assessment explanation and detailed table
        if (result.negative > result.positive) {
          assessmentExplanation.classList.remove('hidden');
          if (result.details && result.details.length > 0) {
            showSentimentTable(result.details);
          }
        } else {
          assessmentExplanation.classList.add('hidden');
          document.getElementById('sentimentTableSection').classList.add('hidden');
        }
      } catch (error) {
        console.error("Upload error:", error);
        uploadResult.textContent = "Error uploading file. Please try again.";
        if (sentimentChart) sentimentChart.destroy();
        assessmentExplanation.classList.add('hidden');
        document.getElementById('sentimentTableSection').classList.add('hidden');
      }
    }

    function showDoughnutChart(positive, neutral, negative) {
      const chartContainer = document.getElementById('chartContainer');
      const ctx = document.getElementById('sentimentChart').getContext('2d');
      if (sentimentChart) sentimentChart.destroy();
      chartContainer.classList.remove('hidden');
      sentimentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Positive', 'Neutral', 'Negative'],
          datasets: [{
            data: [positive, neutral, negative],
            backgroundColor: ['#22C55E', '#3B82F6', '#EF4444'],
            borderWidth: 0,
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#374151',
                font: { size: 14 },
                padding: 20
              }
            },
            tooltip: {
              enabled: true,
              backgroundColor: '#1F2937',
              bodyColor: '#F9FAFB',
              titleColor: '#F9FAFB'
            }
          },
          animation: { duration: 1000, easing: 'easeOutQuart' }
        }
      });
    }

    function showSentimentTable(details) {
      const tableSection = document.getElementById('sentimentTableSection');
      const tableBody = document.getElementById('sentimentTableBody');
      tableBody.innerHTML = "";
      details.forEach(item => {
        const row = document.createElement('tr');
        row.className = "border-t";
        const textCell = document.createElement('td');
        textCell.className = "py-2 px-4";
        textCell.textContent = item.extracted_text || "N/A";
        const sentimentCell = document.createElement('td');
        sentimentCell.className = "py-2 px-4";
        sentimentCell.textContent = item.sentiment || "Negative";
        row.appendChild(textCell);
        row.appendChild(sentimentCell);
        tableBody.appendChild(row);
      });
      tableSection.classList.remove('hidden');
    }

    // Persistent storage handling
    function saveAnalysis() {
      const chartData = sentimentChart ? sentimentChart.data.datasets[0].data : null;
      const tableData = document.getElementById('sentimentTableBody').innerHTML;

      const analysisData = {
        chartData,
        tableData,
        reportExists: localStorage.getItem('assessmentReport') !== null,
      };

      localStorage.setItem('savedAnalysis', JSON.stringify(analysisData));
      alert('Analysis saved successfully!');
    }

    // Refresh page and clear local storage
    function refreshPage() {
      // Clear localStorage
      localStorage.clear();

      // Reset the chart
      const chartContainer = document.getElementById('chartContainer');
      if (sentimentChart) {
        sentimentChart.destroy();
        sentimentChart = null;
      }
      chartContainer.classList.add('hidden');

      // Reset the table
      const tableSection = document.getElementById('sentimentTableSection');
      const tableBody = document.getElementById('sentimentTableBody');
      tableBody.innerHTML = '';
      tableSection.classList.add('hidden');

      // Hide the assessment explanation
      const assessmentExplanation = document.getElementById('assessmentExplanation');
      assessmentExplanation.classList.add('hidden');

      // Hide the download button
      const downloadReportBtn = document.getElementById('downloadReportBtn');
      downloadReportBtn.classList.add('hidden');

      // Reset the upload result
      const uploadResult = document.getElementById('uploadResult');
      uploadResult.textContent = '';

      // Optionally reload the page to fully reset
      location.reload();
    }

    // Load saved analysis on page load
    window.addEventListener('DOMContentLoaded', () => {
      const saved = JSON.parse(localStorage.getItem('savedAnalysis'));
      if (saved) {
        // Restore the chart
        if (saved.chartData) {
          showDoughnutChart(...saved.chartData);
        }

        // Restore the table
        if (saved.tableData) {
          document.getElementById('sentimentTableBody').innerHTML = saved.tableData;
          document.getElementById('sentimentTableSection').classList.remove('hidden');
        }

        // Show the download button if a report exists
        if (saved.reportExists) {
          document.getElementById('downloadReportBtn').classList.remove('hidden');
        }
      }

      const savedReports = JSON.parse(localStorage.getItem('savedReports')) || [];
      if (savedReports.length > 0) {
        const reportList = document.getElementById('reportList');
        savedReports.forEach((report, index) => {
          const reportElement = document.createElement('div');
          reportElement.className = 'p-4 bg-gray-100 rounded-lg shadow flex justify-between items-center';
          reportElement.innerHTML = `
            <span class="text-gray-800">Report - ${new Date(report.timestamp).toLocaleString()}</span>
            <button onclick="downloadSpecificReport(${index})" class="px-4 py-2 bg-teal-500 text-white rounded hover:bg-teal-600">
              Download
            </button>
          `;
          reportList.appendChild(reportElement);
        });

        // Show the download reports section
        document.getElementById('downloadReportsSection').classList.remove('hidden');
      }
    });

    async function downloadReport() {
      const report = localStorage.getItem('assessmentReport');
      if (!report) {
        alert('No report available to download.');
        return;
      }

      try {
        const response = await fetch('/api/generate-pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ report }),
        });

        if (!response.ok) {
          throw new Error('Failed to generate the report.');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ManaNow-Report.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error('Download failed:', error);
      }
    }

    function downloadSpecificReport(index) {
      const savedReports = JSON.parse(localStorage.getItem('savedReports')) || [];
      const report = savedReports[index];
      if (!report) {
        alert('Report not found.');
        return;
      }

      const blob = new Blob([report.content], { type: 'text/html' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ManaNow-Report-${index + 1}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Example: After generating the report in ManaNow
    localStorage.setItem('assessmentReport', JSON.stringify(reportData)); // Save the report
    document.getElementById('downloadReportBtn').classList.remove('hidden'); // Show the button
  </script>
</body>
</html>
